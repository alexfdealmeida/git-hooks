#!/bin/sh

mensagemAviso="Aviso: "
tagHookName="[post-checkout]"
vFileGitModules=".gitmodules"
vCommandGitFetch="git fetch --recurse-submodules --prune"

if [[ "$(pwd)" =~ ^\/\/wsl\.localhost\/ ]]; then
	isDirectoryWslLocalhost=true
else
	isDirectoryWslLocalhost=false
fi

currentBranchName="$(git branch | grep ^* | sed "s/*//" | sed "s/ //")"

if ! [[ "$currentBranchName" =~ "(" ]]; then
	if [ -f $vFileGitModules ]; then
		echo "$tagHookName $mensagemAviso"
		echo "Atualizando referencias locais com o repositorio remoto: '$vCommandGitFetch'"
		$vCommandGitFetch

		if [ "$?" -ne "0" ]; then
			echo -e "\033[1;31mNao foi possivel atualizar as referencias locais com o repositorio remoto\033[0m"
		fi
		
		echo ""

		echo "$tagHookName $mensagemAviso"
		echo "Posicionando nos branches correspondentes dos submodules"
		git submodule foreach --recursive "
			branchSubmodule=\$(git config -f \"\$toplevel/.gitmodules\" submodule.\$name.branch);

			if [ \"\$branchSubmodule\" = \".\" ]; then
				cd \"\$toplevel\";
				branchSuperproject=\$(git branch --show-current);
				cd \"\$sm_path\";
				
				git -c core.hooksPath=/dev/null checkout \$branchSuperproject || echo Nao foi possivel posicionar no branch \$branchSuperproject no submodule \"\$sm_path\"!;
			elif [ -n \"\$branchSubmodule\" ]; then
				git -c core.hooksPath=/dev/null checkout \$branchSubmodule || echo Nao foi possivel posicionar no branch \$branchSubmodule no submodule \"\$sm_path\"!;
			else
				echo Nao foi possivel posicionar no branch correspondente no submodule \"\$sm_path\", pois o branch nao foi especificado no arquivo .gitmodules do superprojeto!;
			fi;
		"
		echo ""
	fi
else
	echo "$tagHookName Skipped: $currentBranchName"
fi

if [ -f "$(dirname "$0")/husky.sh" ]; then
	if ! [[ "$currentBranchName" =~ "(no branch, rebasing" ]]; then
		if [ "$isDirectoryWslLocalhost" == false ]; then
			. "$(dirname "$0")/husky.sh"
		else
			[ -f "copy-git-hooks.sh" ] && chmod +x copy-git-hooks.sh && ./copy-git-hooks.sh --update-only-git-hooks
		fi
	else
		echo "$tagHookName husky > Skipped: $currentBranchName"
	fi
fi