#!/bin/sh

tagHookName="[post-checkout]"
warningMessage="info: "
skippedMessage="skipped: "
copyGitHooks="copy-git-hooks.sh"
vFileGitModules=".gitmodules"
vCommandGitFetch="git fetch --recurse-submodules --prune"

currentBranchName="$(git branch | grep ^* | sed "s/*//" | sed "s/ //")"

if ! [[ "$currentBranchName" =~ "(" ]]; then
	if [ -f $vFileGitModules ]; then
		echo "$tagHookName $warningMessage"
		echo "Atualizando referencias locais com o repositorio remoto: '$vCommandGitFetch'"
		$vCommandGitFetch

		if [ "$?" -ne "0" ]; then
			echo -e "\033[1;31mNao foi possivel atualizar as referencias locais com o repositorio remoto\033[0m"
		fi
		
		echo ""

		echo "$tagHookName $warningMessage"
		echo "Posicionando nos branches correspondentes dos submodules"
		git submodule foreach --recursive "
			branchSubmodule=\$(git config -f \"\$toplevel/.gitmodules\" submodule.\$name.branch);

			if [ \"\$branchSubmodule\" = \".\" ]; then
				cd \"\$toplevel\";
				branchSuperproject=\$(git branch --show-current);
				cd \"\$sm_path\";
				
				git -c core.hooksPath=/dev/null checkout \$branchSuperproject || echo Nao foi possivel posicionar no branch \$branchSuperproject no submodule \"\$sm_path\"!;
			elif [ -n \"\$branchSubmodule\" ]; then
				git -c core.hooksPath=/dev/null checkout \$branchSubmodule || echo Nao foi possivel posicionar no branch \$branchSubmodule no submodule \"\$sm_path\"!;
			else
				echo Nao foi possivel posicionar no branch correspondente no submodule \"\$sm_path\", pois o branch nao foi especificado no arquivo .gitmodules do superprojeto!;
			fi;
		"
		echo ""
	fi
else
	echo "$tagHookName $skippedMessage: $currentBranchName"
	echo ""
fi

echo "$tagHookName $warningMessage"
echo "Verificando pre-requisitos para atualizacao dos hooks"
! [[ "$currentBranchName" =~ "(" ]] && [ -f "$copyGitHooks" ] && chmod +x "$copyGitHooks" && echo "Executando o script '$copyGitHooks'" && ./$copyGitHooks --update-only-git-hooks